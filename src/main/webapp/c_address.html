<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>收货地址</title>
	<script src="js/html5.js"></script>
	<link rel="stylesheet" type="text/css" href="css/styleguide.css">
	<link rel="stylesheet" type="text/css" href="css/font.css">
	<link rel="stylesheet" type="text/css" href="css/address.css">

	<!-- ICON Files -->
	<link rel="shortcut icon" href="ico/favicon.ico">
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png">
	<link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png">
</head>
<body class="logoutredirect">
	<div class="cover">
	</div>
	<header class="h2">
		<div class="h2b">
			<div class="sesearch">
				<input type="text">
				<span class="icon-magnifier13"></span>
			</div>
			<div class="logo">
				<img src="img/logo.png" alt="logo">
			</div>
			<div class="index">
				<a href="index.html">首页</a>
				<div class="dd2">
					<ul>
						<li><a href="culture.html">山茶文化</a></li>
						<li><a href="brand.html">品牌故事</a></li>
						<li><a href="packagedesign.html">私人定制</a></li>
						<li><a href="item_list.html">商品系列</a></li>
						<li><a href="contact.html">联系我们</a></li>
					</ul>
					<div class="lan">
						简
					</div>
					<div class="r">
						<a href="c_orderlist.html">我的订单</a>
						<a href="login.html">登录</a>|<a href="reg.html">注册</a>
					</div>
				</div>
			</div>
			<div class="secart">
				<a href="cart.html">
					购物车
					<div class="cartn">0</div>
				</a>
			</div>
		</div>
	</header>
	<header class="h1">
		<div class="box">
			<div class="logo">
				<img src="img/logo.png" alt="logo">
			</div>
			<div class="ul1">
				<ul>
					<!-- <li class="pinfo">
						<span>130****0000</span>
						<img src="img/avatar_preview_default.png" alt="avatar">
						<ul class="dd1">
							<li><a href="account.html">我的账户</a></li>
							<li>登出</li>
						</ul>
					</li> -->
					<li class="pinfo"><a href="login.html">登录</a>|<a href="reg.html">注册</a></li>
					<li><a href="c_orderlist.html">我的订单</a></li>
				</ul>
				<div class="clear"></div>
			</div>
			<div class="bbs"><a href="bbs/forum.html">论坛</a></div>
			<div class="ul2">
				<ul>
					<li><a href="contact.html">联系我们</a></li>
					<li><a href="item_list.html">商品系列</a></li>
					<li><a href="packagedesign.html">私人定制</a></li>
					<li><a href="brand.html">品牌故事</a></li>
					<li><a href="culture.html">山茶文化</a></li>
					<li class="active"><a href="index.html">首页</a></li>
				</ul>
			</div>
		</div>
	</header>
	<div class="boxw se">
		<div class="box">
			<ul><li class="active">中</li><li>繁</li><li>JP</li><li>EN</li></ul>
			<div class="sesearch">
				<input type="text" name="seinput">
				<input type="button" name="sebtn" value="搜索">
			</div>
			<div class="secart">
				<a href="cart.html">
					购物车
					<div class="cartn">0</div>
					<span class="icon-arrow-down2"></span>
				</a>
			</div>
		</div>
	</div>
	<div class="clear waypoint"></div>
	<div class="box hcl">
		<div class="hcartlist">
			<div class="list">
				<table>
					<!-- <tr>
						<td class="td1">
							<div class="img">
								<img src="img/listitem.png" alt="img">
							</div>
							<p>
								<span class="n">红天果冷压榨特级初榨茶籽油</span><br>
								<span class="s">500ML</span>
							</p>
						</td>
						<td class="td2">1</td>
						<td class="td3">&yen;200</td>
						<td class="td4">
							<span class="icon-cross"></span>
						</td>
					</tr> -->
				</table>
			</div>
			<div class="b">
				<span class="ttn">共<span>0</span>件商品</span>
				<span class="ttp">总价<span>&yen;0</span></span>
				<input type="button" id="carthtml" value="结算">
			</div>
		</div>
	</div>
	<div class="box">
		<div class="popup" id="popup">
			<h3>
				<span class="icon-square"></span>收货地址
			</h3>
			<div>
				<p>收货人姓名<span class="required">*必填</span></p>
				<div class="error"><div></div><span>必填</span></div>
				<input type="text" name="rec" maxlength="128">
			</div>
			<div>
				<p>所在地<span class="required">*必填</span></p>
				<div class="error"><div></div><span>必填</span></div>
				<select id="province"></select>
				<select id="city"></select>
				<select id="region"></select>
			</div>
			<div>
				<p>详细地址<span class="required">*必填</span></p>
				<div class="error"><div></div><span>必填</span></div>
				<textarea name="address" maxlength="50"></textarea>
			</div>
			<div>
				<p>手机号码<span class="required">*必填</span></p>
				<div class="error"><div></div><span>必填</span></div>
				<input type="text" name="tel" maxlength="11">
			</div>
			<div>
				<p>邮政编码</p>
				<div class="error"><div></div><span>必填</span></div>
				<input type="text" name="poco" maxlength="6">
			</div>
			<div>
				<p>固定电话</p>
				<div class="error"><div></div><span>必填</span></div>
				<input type="text" name="pho" maxlength="12">
			</div>
			<div>
				<p>邮箱</p>
				<div class="error"><div></div><span>必填</span></div>
				<input type="text" name="eml" max-length="128">
			</div>
			<input type="button" name="submit" value="保存">
			<input type="button" name="cancel" value="取消">
			<div class="sbmte">网络连接错误，请重试</div>
		</div>
		<div class="acctmenu" data-index="nav23">
		</div>
		<div class="content">
			<div class="addrst" name="eaddr">
				<span class="zaddr">您已创建0个收货地址，最多可创建8个</span>
				<span class="eaddr">您已创建8个收货地址，删除后可创建新地址</span>
			</div>
			<input type="button" id="newaddr" value="创建新地址">
			<div class="addrlist">
				<!-- <div class="addr" data-addrid="0">
					<div class="def">
						默认地址
					</div>
					<div class="board">
					</div>
					<div class="btn">
						<div class="addrbtn">
							<input type="button" name="edit" value="编辑">
							<input type="button" name="delete" value="删除">
							<div class="delconf">
								<input type="button" name="delcanc" value="取消">
								<input type="button" name="delconf" value="确认删除">
								<div class="dcdec"></div>
							</div>
						</div>
						<div class="addrdef">设为默认地址</div>
					</div>
					<p>杨羊<span>186-9078-9045</span></p>
					<p>天津市河西区解放南路地区01单元09街坊</p>
					<div class="info">
						<span>邮编：100121</span>
						<span>固话：489068</span>
						<span>邮箱：489068@qq.com</span>
					</div>
				</div> -->
			</div>
		</div>
	</div>
	<footer>
		<div class="box">
			<div class="l">
				<p>
					客户服务<br>
					<span id="site_phone">025-85703619</span>
				</p>
				<p>
					地址<br>
					<span id="site_address">江苏省南京市雨花台区长虹路222号<br>
						德盈国际广场3幢1605室<br>
						江苏红果文化传播有限公司</span>
				</p>
				<p>
					邮箱<br>
					<span id="site_email">srv@uhaou.cn</span>
				</p>
			</div>
			<div class="m">
				<p>订阅有好油，加入我们</p>
				<div class="rss">
					<input type="text" placeholder="请输入您的邮箱">
					<input type="button" value="发送">
				</div>
			</div>
			<div class="r">
				<p>扫一扫有惊喜</p>
				<img id="site_2dcode" src="img/2dcode.jpg" alt="code">
				<div class="site">UHAOU.CN</div>
				<div class="cr" id="site_record">
				</div>
			</div>
		</div>
	</footer>
	<script src="js/jquery.js"></script>
	<script src="js/jquery.cookie.js"></script>
	<script src="js/general.js"></script>
	<script src="js/waypoints.min.js"></script>
	<script type="text/javascript">
		$(document).ready(function(){
			function resetPopup(){
				$("#popup .error, #popup .sbmte").hide();
				$("#popup input[type=text]").val("");
				$("#popup textarea").val("");
				$("#popup").removeAttr("name").removeAttr("data-addrid");
				$("#province>option, #city>option, #region>option").remove("");
				loadData('#province', '1');
				$("#province").change();
				$("#city").change();
			}

			if (loginData) {
				if (loginData.success != 0) {
					window.location.href = "login.html";
				}
			}else{
				//window.location.href = "login.html";
			}

			$("#newaddr").click(function(){
				if ($(".addr").length < 8) {
					resetPopup();
					$("#popup input[name=submit]").attr("name","add");
					$(".cover").show();
					$("#popup").show();
				}else{
					$(".addrst").show();
					$("#newaddr").addClass("disabled");
				}
			});

			$("span.addredit").click(function(){
				resetPopup();
				var addrid = $(this).parents(".addr").attr("data-addrid");
				$("#popup").attr("name","edit").attr("data-addrid",addrid);
				$(".cover").show();
				$("#popup").show();
			});

			$("#popup input[name=cancel]").click(function(){
				$(".cover").hide();
				$("#popup").hide();
				resetPopup();
			});

			function loadData(id, parent_id) {
				$.ajax({
					url: './regions/get',
					data: {parent_id: parent_id},
					cache:false,
					async: false,
					success: function(data) {
						for(var i=0; i<data.length; i++) {
							$(id).html();
							$(id).siblings(".error").hide();
							$(id).append('<option value="'+data[i].region_id+'">'+ data[i].region_name +'</option>');
						}
					}
				});
			}

			function getaddr(){
				$.ajax({
					type:"get",
					data:{accountId:accountid},
					async:false,
					cache:false,
					url:"./passport/address",
					success:function(data){
						if (data.success == 0) {
							if (data.length == 8) {
								$(".addrst").attr("name","eaddr").show();
								$("#addaddr").attr("disabled","disabled").addClass("disabled");
							}else if (data.length == 0){
								$(".addrst").attr("name","zaddr").show();
								$("#addaddr").removeAttr("disabled").removeClass("disabled");
							}else{
								$(".addrst").hide();
								$("#addaddr").removeAttr("disabled").removeClass("disabled");
							}
							$(".addrlist").empty();

							for (var i = 0; i <= data.length - 1; i++) {
								var regionName='';
								if(data.datas[i].region != null) {
									regionName = data.datas[i].region.region_name;
								}
								$(".addrlist").append('<div class="addr" data-addrid="'+data.datas[i].id+'"><div class="def">默认地址</div><div class="board"></div><div class="btn"><div class="addrbtn"><input type="button" name="edit" value="编辑"><input type="button" name="delete" value="删除"><div class="delconf"><input type="button" name="delcanc" value="取消"><input type="button" name="delconf" value="确认删除"><div class="dcdec"></div></div></div><div class="addrdef">设为默认地址</div></div><p>'+data.datas[i].recipient+'<span>'+data.datas[i].telephone+'</span></p><p>'+data.datas[i].nation.region_name + data.datas[i].province.region_name + data.datas[i].city.region_name + regionName + data.datas[i].address+'</p><div class="info"></div></div>');

								if (data.datas[i].postcode) {
									$(".addr[data-addrid="+data.datas[i].id+"] .info").append('<span>邮编：'+data.datas[i].postcode+'</span>');
								}
								if (data.datas[i].phone) {
									$(".addr[data-addrid="+data.datas[i].id+"] .info").append('<span>固话：'+data.datas[i].phone+'</span>');
								}
								if (data.datas[i].email) {
									$(".addr[data-addrid="+data.datas[i].id+"] .info").append('<span>邮箱：'+data.datas[i].email+'</span>');
								}
								if (data.datas[i].isDefault == 1){
									$(".addrlist .addr[data-addrid="+data.datas[i].id+"]").addClass("default");
								}
							}
						}
					}
				});
			}

			getaddr();

			$('#city').live('change',function() {
				var parent_id = $('#city').val();
				$('#region>option').remove();
				loadData('#region', parent_id);
			});

			$('#province').live('change',function() {
				var parent_id = $('#province').val();
				$('#city>option').remove();
				$('#region>option').remove();
				loadData('#city', parent_id);
				loadData("#region", $("#city").val());
			});

			//setDefault
			$(".addr .btn .addrdef").removeAttr("disabled");
			$(".addr .btn .addrdef").live("click",function(){
				$(this).attr("disabled","disabled");
				var item = $(this).parents(".addr");
				$.ajax({
					type:"put",
					data:{
						addressId: item.attr("data-addrid"),
					},
					async:false,
					cache:false,
					url:"./passport/address/setDefault",
					success:function(data){
						if (data.success == 0) {
							$(".addr").removeClass("default");
							item.addClass("default");
						}
					}
				});
				$(this).removeAttr("disabled");
			});

			//deleteAddr
			$(".addr input[name=delete]").live("click",function(){
				$(this).siblings(".delconf").show();
			});

			$(".addr input[name=delcanc]").live("click",function(){
				$(this).parent(".delconf").hide();
			});

			$(".addr").mouseleave(function(){
				var addrid = $(this).attr("data-addrid");
				$(".addr[data-addrid="+addrid+"] .delconf").hide();
			});

			$(".addr input[name=delconf]").live("click",function(){
				var addrid = $(this).parents(".addr").attr("data-addrid");
				$.ajax({
					type:"delete",
					data:{},
					cache:false,
					async:false,
					url:"./passport/address?addressId=" + addrid,
					success:function(data){
						if (data.success == 0) {
							$(".addr[data-addrid="+addrid+"]").remove();
						}
					}
				});
			});

			//editAddr
			$(".addr input[name=edit]").live("click",function(){
				var addrid = $(this).parents('.addr').attr("data-addrid");
				resetPopup();
				$("#popup input[name=submit]").attr("name","edit").attr("data-addrid",addrid);
				$.ajax({
					type:"get",
					data:{accountId:accountid},
					url:"./passport/address",
					cache:false,
					async:false,
					success:function(data){
						if (data.success == 0) {
							for (var i = 0; i <= data.length - 1; i++) {
								if (data.datas[i].id == addrid) {
									$("#popup input[name=rec]").val(data.datas[i].recipient);
									$("#popup input[name=tel]").val(data.datas[i].telephone);
									$("#popup input[name=pho]").val(data.datas[i].phone);
									$("#popup input[name=poco]").val(data.datas[i].postcode);
									$("#popup input[name=eml]").val(data.datas[i].email);
									$("#popup textarea[name=address]").val(data.datas[i].address);
									$("#province").val(data.datas[i].province.region_id);
									$('#province').change();
									$("#city").val(data.datas[i].city.region_id);
									$('#city').change();
									if(data.datas[i].region != null) {
										$("#region").val(data.datas[i].region.region_id);
									}
								}
							}
							$("#popup, .cover").show();
						}
					}
				});
			});

			//popup
			var sus = 1;
			function tipDisplay(tip,e){
				if (tip) {
					sus = 0;
					e.show().children("span").text(tip);
				}else{
					e.hide();
				}
			}

			$("input[name=rec]").blur(function(){
				var e = $(this).siblings(".error");
				var tip = "";
				var v = $(this).val();
				if (!v) {
					tip = "收件人姓名必填";
				}else if(!$().fnamevalidate(v)){
					tip = "请不要使用特殊符号并不少于两个字符";
				}

				tipDisplay(tip,e);
			});

			$("textarea[name=address]").blur(function(){
				var e = $(this).siblings(".error");
				var tip = "";
				var v = $(this).val();
				if (!v) {
					tip = "详细地址必填";
				}else if(!$().addrvalidate(v)){
					tip = "请不要使用特殊符号并不少于两个字符";
				}

				tipDisplay(tip,e);
			});

			$("input[name=tel]").blur(function(){
				var e = $(this).siblings(".error");
				var tip = "";
				var v = $(this).val();
				if (!v) {
					tip = "手机号必填";
				}else if(!$().telvalidate(v)){
					tip = "手机号格式不正确";
				}
				tipDisplay(tip,e);
			});

			$("input[name=poco]").blur(function(){
				var e = $(this).siblings(".error");
				var tip = "";
				var v = $(this).val();
				if(v){
					if(!$().postvalidate(v)){
						tip = "邮政编码格式不正确";
					}
				}
				tipDisplay(tip,e);
			});

			$("input[name=pho]").blur(function(){
				var e = $(this).siblings(".error");
				var tip = "";
				var v = $(this).val();
				if(v){
					if(!$().phonevalidate(v)){
						tip = "固定电话格式不正确，示例：01012345678";
					}
				}
				tipDisplay(tip,e);
			});

			$("input[name=eml]").blur(function(){
				var e = $(this).siblings(".error");
				var tip = "";
				var v = $(this).val();
				if(v){
					if(!$().emailvalidate(v)){
						tip = "电子邮箱格式不正确";
					}
				}
				tipDisplay(tip,e);
			});

			$("#popup input[name=submit]").removeAttr("disabled");
			$("#popup input[name=submit]").click(function(){
				$(this).attr("disabled","disabled");
				sus = 1;
				$("#popup input[type=text], #popup textarea[name=address]").blur();
				function locaError(){
					sus = 0;
					$("#province").siblings(".error").children("span").text("所在地必填");
					$("#province").siblings(".error").show();
				}

				if ($("#province").val() < 0) {
					locaError();
				}else if ($("#city").val() < 0) {
					locaError();
				}else if($("#region").val() < 0){
					locaError();
				}else{
					$("#province").siblings(".error").hide();
				}
				console.log(sus);
				if (sus){
					var type = $(this).attr("name");
					var addrid;
					if (type == "edit") {
						addrid = $(this).attr("data-addrid");
						$.ajax({
							type:"put",
							data:{
								addressId: addrid,
								nation:"",
								province:$("#province").val(),
								city:$("#city").val(),
								region:$("#region").val(),
								address:$("#popup textarea[name=address]").val(),
								postcode:$("#popup input[name=poco]").val(),
								recipient:$("#popup input[name=rec]").val(),
								telephone:$("#popup input[name=tel]").val(),
								phone:$("#popup input[name=pho]").val(),
								email:$("#popup input[name=eml]").val()
							},
							url:"./passport/address",
							error:function(){
								$("#popup .sbmte").text("网络连接错误，请重试").show();
							},
							success:function(data){
								if (data.success == 0) {
									$("#popup input[name=cancel]").click();
									getaddr();
								}else if (data.error == 201) {
									$("#popup .sbmte").text("格式错误").show();
								}else{
									window.location.href="error.html";
								}
							}
						});
					}else if(type == "add"){
						$.ajax({
							type:"post",
							data:{
								accountId:accountid,
								nation:"",
								province:$("#province").val(),
								city:$("#city").val(),
								region:$("#region").val(),
								address:$("#popup textarea[name=address]").val(),
								postcode:$("#popup input[name=poco]").val(),
								recipient:$("#popup input[name=rec]").val(),
								telephone:$("#popup input[name=tel]").val(),
								phone:$("#popup input[name=pho]").val(),
								email:$("#popup input[name=eml]").val()
							},
							url:"./passport/address",
							error:function(){
								$("#popup .sbmte").text("网络连接错误，请重试").show();
							},
							success:function(data){
								if (data.success == 0) {
									$("#popup input[name=cancel]").click();
									getaddr();
								}else if (data.error == 201) {
									$("#popup .sbmte").text("格式错误").show();
								}else{
									window.location.href="error.html";
								}
							}
						});
					}
				}
				$(this).removeAttr("disabled");
			});
		});
	</script>
</body>
</html>
