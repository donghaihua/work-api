<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>订单列表</title>
	<script src="js/html5.js"></script>
	<link rel="stylesheet" type="text/css" href="css/console.css">
	<link rel="stylesheet" type="text/css" href="css/font.css">
	<link rel="stylesheet" type="text/css" href="css/borderlist.css">
	
	<!-- ICON Files -->
	<link rel="shortcut icon" href="ico/favicon.ico">
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png">
	<link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png">
</head>
<body>
	<div class="cover">
	</div>
	<header>
		<div class="wrapper">
			<div class="logo">
				<img src="img/kmlogo_white.png" alt="logo">
			</div>
			<div class="breadcrumb">
			</div>
			<div class="userinfo">
				<img src="img/avatar_preview_default.png" alt="avatar">
				<span class="username"><span class="un"></span><span class="icon-arrow-down"></span></span>
			</div>
			<span class="icon-notif new"><span class="icon-dot"></span></span>
			<span class="icon-mail new"><span class="icon-dot"></span></span>
			<ul class="ddlist">
			</ul>
		</div>
	</header>
	<div class="wrapper">
		<div class="popup" id="popup" style="display: none;">
			<div class="cancel"></div>
			<div class="icon-cross"></div>
			<h3>
				<span class="icon-square">收货信息</span>
				<div class="error" style="display:none"></div>
				<input type="button" id="send" value="发货">
			</h3>
			<div class="addr">
				<span class="recpt"></span>
				<span class="tel"></span><br>
				<span class="addrd"></span>
			</div>
			<h3>
				<span class="icon-square">物流信息</span>
			</h3>
			<p>物流公司</p>
			<select id="express_name">
				
			</select>
			<p>物流单号</p>
			<input id="express" type="text">
		</div>
		<div class="popup" id="popup-extract" style="display: none;">
			<div class="cancel"></div>
			<div class="icon-cross"></div>
			<h3>
				<span class="icon-square">自提信息</span>
				<div class="error extract-error" style="display:none"></div>
				<input type="button" id="extract-complete" value="完成">
			</h3>
			<p>自提人姓名</p>
			<input type="text" id="extractName">
			<p>手机号</p>
			<input id="extractTel" type="tel">
			<p>取货时间</p>
			<input id="extractDate" type="date">
		</div>
		<div id="sidebar" data-index="nav21">
		</div>
		<div id="content">
			<table class="search">
				<tr>
					<th class="td1">订单编号、手机号</th>
					<th class="td2">订单日期</th>
				</tr>
				<tr>
					<td class="td1">
						<input type="text" id="orderParam" name="skey">
					</td>
					<td class="td2">
						<input type="date" id="startDate" name="date">
						<span>-</span>
						<input type="date" id="endDate" name="date">
						<input type="button" id="b_search" value="搜索">
					</td>
				</tr>
			</table>
			<div class="ordernav">
				<ul>
					<li class="active" name="ot1">全部订单</li>
					<li name="ot2">等待出库</li>
					<li name="ot3">退款订单</li>
				</ul>
			</div>
			<div name="order_all" class="order ot1">
				<div class="otitle">
					<span>
						<span class="icon-dot"></span>
						订单编号:
						<span class="on"></span>
						下单时间:
						<span class="ot"></span>
						订单总额:
						<span class="op">&yen;<span></span></span>
						<span class="os"></span>
						<span class="os"></span>
					</span>
				</div>
				<table name="order_item">
					<tr>
						<th class="td1">商品名称</th>
						<th class="td2">单价</th>
						<th class="td3">数量</th>
						<th class="td4">金额</th>
						<th class="td5">买家备注</th>
					</tr>
				</table>
				<div class="receipt">

				</div>
				<div class="btn">
					<input type="button" value="操作" name="oper">
					<div class="oper">
					</div>
				</div>
			</div>

			<div name="order_notDelivery" class="order ot2"  style="display: none">
				<div class="otitle">
					<span>
						<span class="icon-dot"></span>
						订单编号:
						<span class="on"></span>
						下单时间:
						<span class="ot"></span>
						订单总额:
						<span class="op">&yen;<span></span></span>
						<span class="os"></span>
						<span class="os"></span>
					</span>
				</div>
				<table name="order_item">
					<tr>
						<th class="td1">商品名称</th>
						<th class="td2">单价</th>
						<th class="td3">数量</th>
						<th class="td4">金额</th>
						<th class="td5">买家备注</th>
					</tr>
				</table>
				<div class="receipt">
				</div>
				<div class="btn">
					<input type="button" value="操作" name="oper">
					<div class="oper">
					</div>
				</div>
			</div>
			
			<div name="order_refund" class="order ot3" style="display: none">
				<div class="otitle">
					<span>
						<span class="icon-dot"></span>
						订单编号:
						<span class="on"></span>
						下单时间:
						<span class="ot"></span>
						订单总额:
						<span class="op">&yen;<span></span></span>
						<span class="os"></span>
						<span class="os"></span>
					</span>
				</div>
				<table name="order_item">
					<tr>
						<th class="td1">商品名称</th>
						<th class="td2">单价</th>
						<th class="td3">数量</th>
						<th class="td4">金额</th>
						<th class="td5">买家备注</th>
					</tr>
				</table>
				<div class="receipt">
				</div>
				<div class="btn">
					<input type="button" value="操作" name="oper">
					<div class="oper">
					</div>
				</div>
			</div>
			<div class="pager">
				<span class="page">
					<!-- <a>1</a>
					<a class="current">2</a>
					<a>3</a>
					<a>4</a>
					<a>5</a>
					<span>&hellip;</span>
					<a>17</a>
					<span class="nextpage">下一页<span class="icon-arrow-right2"></span></span> -->
				</span>
			</div>
			<div class="clearr"></div>
		</div>
		<div class="sidebarb">
			<div class="up">
				<div class="icon-arrow-up"></div>
			</div>
			<div class="copyright" id="site_record">
			</div>
		</div>
	</div>
	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/a_general.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			$('#popup').find('div.icon-cross').click(function() {
				$('#popup').hide();
				$('.cover').hide();
			});
            $('#popup-extract').find('div.icon-cross').click(function() {
                $('#popup-extract').hide();
                $('.cover').hide();
            });
			var currIndex = 0;
			var orderNo = '';
			var addressMap = {};
			
			setOrderHtml1(1);
			
			$('#b_search').click(function() {
				$('div.ordernav>ul>li:eq(0)').click();
				setOrderHtml1(1);
			});
			
			var sel="";
			$.ajax({
				type: 'get',
				url: './s/delivery',
				success: function(data){
					if(data.datas){
						for(var i = 0; i<data.datas.length; i++){
							sel +=	"<option value='"+data.datas[i].name+"'>"+data.datas[i].name+"</option>";
						}
					}
					$('#express_name').append(sel);
				}
			});
			
			// 发货
			$('#send').click(function() {
				var express_no = $('#express').val();
				$('#popup').find('.error').show();
				var express_name = $('#express_name').val();
				console.log(express_name);
				if(express_no.trim().length == 0) {
					$('#popup').find('.error').text('请填写物流单号！');
					return;
				}
				if(/^\d+$/.test(express_no) == false) {
					$('#popup').find('.error').text('物流单号只能由数字组成！');
					return;
				}
				if(addressMap[orderNo].state != 3) {
					$('#popup').find('.error').text('该订单未付款，无法发货！');
				} else {
					$.ajax({
						type: 'POST',
						url: './sale/order/send',
						data: {'orderNo': orderNo, 'express': express_no, 'express_name': express_name},
						success: function(data) {
							if(data.success == 1) {
								if(data.error == 101) {
									$('#popup').find('.error').text('请确认订单是否存在！');
								} else if (data.error == 401) { // 跳错误页面
									
								} else if (data.error == 201) {
									$('#popup').find('.error').text('单号填写不正确');
								} else if (data.error == 1) { // 跳错误页面
									$('#popup').find('.error').text('订单未付款，无法发货');
								}
							} else if(data.success == 0) { // 发货成功
								$('#popup').find('div.icon-cross').click();
								window.location.reload();
							}
						}
					});
				}
			});

			// 自提完成
			$('#extract-complete').click(function() {
			    $('#popup-extract').find('.extract-error').show();
			    let extractName = $('#extractName').val();
			    let extractTel = $('#extractTel').val();
			    let extractDate = $('#extractDate').val()
				if (extractName.trim().length === 0) {
                    $('#popup-extract').find('.extract-error').text("请填写自提人姓名！");
                    return;
				}
				if (!/^1[3|4|5|7|8][0-9]{9}$/.test(extractTel)) {
                    $('#popup-extract').find('.extract-error').text('手机号码不正确！');
                    return;
				}
				if (!extractDate) {
                	$('#popup-extract').find('.extract-error').text('请填写取货时间！');
                	return;
				}
				const extractData = {
			        orderNo: orderNo,
					pickName: extractName,
                    pickPhoneNumber: extractTel,
                    pickTime:extractDate
				}
				$.ajax({
					url: './sale/order/pick',
					type: 'post',
					data: extractData,
					success: function (res) {
                        if(res.success == 0) { // 发货成功
                            $('#popup-extract').find('div.icon-cross').click();
                            window.location.reload();
                        } else {
                            $('#popup-extract').find('.error').text('提交错误');
						}
					},
					fail: function (error) {
						console.error(error)
					}
				})
			});
			
			//tab
			$(".ordernav ul li").click(function(){
				var ot = $(this).attr("name").substring(2,3);
				$(".order").hide();
				if (ot == 1) {
					setOrderHtml1(1);
				}else if(ot == 2){
					setOrderHtml2(1);
				}else if(ot == 3){
					setOrderHtml3(1);
					$("div[name=order_refund]").show();
				}
				
				$(this).siblings("li").removeClass("active");
				$(this).addClass("active");
			});

			$(".page a:not(.current)").live("click",function(){
				var page = $(this).attr("class").split("pageid")[1];
				var ot = $(".page").attr("name");
				if(ot == "ot1") {
					setOrderHtml1(parseInt(page));
				}else if(ot == "ot2"){
					setOrderHtml2(parseInt(page));
				}else if(ot == "ot3"){
					setOrderHtml3(parseInt(page));
				}
			});

			$(".page .nextpage").live("click",function(){
				var page = $(this).siblings("a.current").attr("class").split(" ")[0].split("pageid")[1];
				var ot = $(".page").attr("name");
				if(ot == "ot1") {
					setOrderHtml1(parseInt(page)+1);
				}else if(ot == "ot2"){
					setOrderHtml2(parseInt(page)+1);
				}else if(ot == "ot3"){
					setOrderHtml3(parseInt(page)+1);
				}
			});
			
			function setOrderHtml1(page) {
				//加载订单信息
				$.ajax({
					type: 'GET',
					url: './sale/order',
					data: {
						'page': page,
						'limit': 3,
						'back': 0,
						'orderParam': $('#orderParam').val(), 
						'startDate': $('#startDate').val(), 
						'endDate': $('#endDate').val()
					},
					success: function(data) {
						if(data.datas && data.datas.length > 0) {
							setOrderData(data.datas, 0);
							setViewOrder_click();
							setDispatch_click();
                            setExtract_click();
							setRejection_click();
						}
						$().pagegenerator(data.lastPage, page);
						$(".page").attr("name","ot1");
					}
				});				
			}

			function setOrderHtml2(page) {
				//加载出库信息
				$.ajax({
					type: 'GET',
					url: './sale/order',
					data: {
						'page': page, 
						'limit': 3,
						'back': 0,
						'state': 3,
						'orderParam': $('#orderParam').val(), 
						'startDate': $('#startDate').val(), 
						'endDate': $('#endDate').val()
					},
					success: function(data) {
						if(data.datas && data.datas.length > 0) {
							setOrderData(data.datas, 1);
							setViewOrder_click();
							setDispatch_click();
						}
						$().pagegenerator(data.lastPage, page);
						$(".page").attr("name","ot2");
					}
				});
			}

			function setOrderHtml3(page) {
				//加载退款信息
				$.ajax({
					type: 'GET',
					url: './sale/order',
					data: {
						'page': page,
						'limit': 10,
						'back': 0,
						'state': '5-6',
						'orderParam': $('#orderParam').val(), 
						'startDate': $('#startDate').val(), 
						'endDate': $('#endDate').val()
					},
					success: function(data) {
						if(data.datas && data.datas.length > 0) {
							setOrderData(data.datas, 2);
							setViewOrder_click();
							setRejection_click();
						}
						$().pagegenerator(data.lastPage, page);
						$(".page").attr("name","ot3");
					}
				});
			}
			
			function setOrderData(orderArray, divIndex) {
				clearContent(divIndex);
				var div_sec = '';
				if(divIndex == 0) {
					div_sec = 'div[name=order_all]';
				} else if (divIndex == 1) {
					div_sec = 'div[name=order_notDelivery]';
				} else if (divIndex == 2) {
					div_sec = 'div[name=order_refund]';
				}
				/* var isShow = false;
				if(divIndex == currIndex) {
					isShow = true;
				} */
				var div_sec_zero = div_sec + ':eq(0)';
				
				// 先把DIV整个的弄出来，再分别进行赋值
				for(var i = 0; i < orderArray.length-1; i++) {
					var orderDiv_clone = $(div_sec_zero).clone();
					$(div_sec_zero).after(orderDiv_clone);
				}
				
				$(div_sec).each(function(index) {
					var order = orderArray[index];
					
					var saleOrder = {
						"orderNo": order.orderNo,
						"address": order.address,
						"name": order.recipient,
						"telephone": order.telephone,
						"state": order.state
					};
					addressMap[order.orderNo] = saleOrder;
					
					$(this).find('div.otitle').find('span.on').text(order.orderNo);
					$(this).find('div.otitle').find('span.ot').text(order.dealDate);
					$(this).find('div.otitle').find('span.op>span').text(order.totalPrice);
					
					var state_word = '';
					var refund_word = '';
					
					if(order.state == 0) {
						state_word = '已发货';
					} else if(order.state == 1) {
						state_word = '已评价';
					} else if(order.state == 2) {
						state_word = '待付款';
					} else if(order.state == 3) {
						state_word = '等待发货';
					} else if(order.state == 4) {
						state_word = '已取消';
					}
					
					if(order.state == 5) {
						refund_word = '待退款';
					} else if(order.state == 6) {
						refund_word = '已退款';
					}
					
					if(state_word.trim().length > 0) {
						$(this).find('div.otitle').find('span.os:eq(0)').text(state_word);
					} else {
						$(this).find('div.otitle').find('span.os:eq(0)').hide();
					}
					
					if(refund_word.trim().length > 0) {
						$(this).find('div.otitle').find('span.os:eq(1)').text(refund_word);
					} else {
						$(this).find('div.otitle').find('span.os:eq(1)').hide();
					}

					var fapiao = '<h4>发票信息</h4><p>';
					if(order.invoiceType == 0) {
						fapiao += '不需要发票';
					} else if(order.invoiceType == 1) {
						fapiao += '个人发票';
					} else if(order.invoiceType == 2) {
						fapiao += '公司发票，抬头：' + order.invoiceTitle;
					}
					fapiao += '</p>';
					$(this).find('div.receipt').html(fapiao);
					
					var dispatch_html = '<input type="button" order_no="'+order.orderNo+'" value="发货" name="dispatch"><br>';
					var rejection_html = '<input type="button" order_no="'+order.orderNo+'" value="退款申请" name="rejection">';
					let extract_html = '<input type="button" order_no="'+order.orderNo+'" value="自提" name="extract"><br>';
					for(var i = 0; i < order.saleOrderDetails.length; i++) {
						var orderDetail = order.saleOrderDetails[i];
						var row_span = order.saleOrderDetails.length;
						var spec = orderDetail.saleItemSpec;
						
						var tr_html = '<tr><td class="td1"><div class="img">';
						tr_html += '<img src="'+orderDetail.lightItem.avatar+'" alt="img"></div><p>';
						tr_html += '<span class="b">'+order.lightShop.brandName+'</span><br>';
						tr_html += '<span class="n">'+orderDetail.lightItem.name+'</span><br>';
						tr_html += '<span class="s">'+spec.specName+'</span>';
						
						tr_html += '</p></td><td class="td2">';
						tr_html += '&yen;' + spec.discountPrice;
						
						tr_html += '</td><td class="td3">';
						tr_html += orderDetail.quantity;
						
						tr_html += '</td><td class="td4">';
// 						tr_html += '&yen;' + order.totalPrice + "</td>";
						tr_html += '&yen;' + spec.discountPrice*orderDetail.quantity + "</td>";
						if(i == 0) {
							tr_html += '<td class="td5" rowspan="'+row_span+'"><span>手机号：'+ order.telephone +'</span><p>';
							tr_html += order.remarks + '</p></td>';
						}
						
						tr_html += '</tr>';
						
						$(this).find('table[name=order_item]:eq(0)').append(tr_html);
						
						if(order.state == 3 && order.logistics_id === 1) {
							$(this).find('div.oper').html(extract_html);
						} else if(order.state == 3 && order.logistics_id !== 1) {
                            $(this).find('div.oper').html(dispatch_html);
						}else if(order.state == 5 || order.state == 6) {
							$(this).find('div.oper').html(rejection_html);
						}
					}
				});
				$(div_sec).show();
				/* if(isShow) {
					$(div_sec).show();
				} */
			}
			
			function clearContent(divIndex) {
				var div_sec = '';
				
				if(divIndex == 0) {
					div_sec = 'div[name=order_all]';
				} else if (divIndex == 1) {
					div_sec = 'div[name=order_notDelivery]';
				} else if (divIndex == 2) {
					div_sec = 'div[name=order_refund]';
				}
				var div_sec_zero = div_sec + ':eq(0)';
				$(div_sec).each(function(index) {
					if(index > 0) {
						$(this).remove();
					}
					$(this).find('table[name=order_item]').find('tr:gt(0)').each(function() {
						$(this).remove();
					});
				});
				$(div_sec_zero).hide();
				
			}
			// 查看订单详情
			function setViewOrder_click() {
				$('.otitle').each(function(){
					$(this).click(function() {
						var orderNo = $(this).find('span.on').text();
						if(orderNo.length == 0 || orderNo == undefined) {
							return;
						}
						window.location.href='./a_orderdetail.html?val=' + orderNo;
					})
				})
			}
			
			// 调用发货界面
			function setDispatch_click() {
				$('input[name=dispatch]').each(function() {
					$(this).click(function() {
						orderNo = $(this).attr('order_no');
						$('#popup').show();
						$('.cover').show();
						$('#popup').find('.recpt').text(addressMap[orderNo].name);
						$('#popup').find('.tel').text(addressMap[orderNo].address);
						$('#popup').find('.addrd').text(addressMap[orderNo].telephone);
					})
				});
			}

			//调用自提界面
			function setExtract_click() {
			    $('input[name=extract]').each(function() {
			        $(this).click(function() {
                        orderNo = $(this).attr('order_no');
                        $('#popup-extract').show();
                        $('.cover').show();
					})
				})
			}
			
			// 退款
			function setRejection_click() {
				$('input[name=rejection]').each(function() {
					$(this).click(function() {
						orderNo = $(this).attr('order_no');
						window.location.href='./a_refund.html?val=' + orderNo;
					});
				});
			}
		})
	</script>
</body>
</html>